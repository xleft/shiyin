<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯—éš - å¯è¿è¡Œç½‘é¡µç‰ˆ</title>
  
<!-- æœ¬åœ° React å’Œ Babelï¼ˆè‡ªåŒ…å«ç‰ˆï¼‰ -->
<script src="react.production.min.js"></script>
<script src="react-dom.production.min.js"></script>
<script src="babel.min.js"></script>
  
  <style>
    /* åŸºæœ¬æ ·å¼é‡ç½®å’Œå…¨å±€å­—ä½“ */
    body {
      margin: 0;
      min-height: 100vh;
      background-color: #F8F6F1;
      font-family: 'STKaiti', 'KaiTi', serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    #root {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    /* è§£å†³ Lucide å›¾æ ‡é»˜è®¤å¤§å°é—®é¢˜ */
    i[data-lucide] {
      width: 16px;
      height: 16px;
      display: inline-block;
      vertical-align: middle;
      margin-top: -2px;
    }
    
    button {
      font-family: 'STKaiti', 'KaiTi', serif;
    }
    
    /* å›¾ç‰‡æ ·å¼ */
    .painting-image {
      max-width: 100%;
      border-radius: 8px;
      margin-top: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* åŠ è½½åŠ¨ç”» */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(139,157,131,0.3);
      border-radius: 50%;
      border-top-color: #8B9D83;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <!-- React åº”ç”¨çš„æ ¹èŠ‚ç‚¹ -->
  <div id="root"></div>

  <!-- React ç»„ä»¶ä»£ç  -->
  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // å†…ç½® SVG å›¾æ ‡ï¼ˆé›¶ä¾èµ–ï¼Œæ°¸ä¸ç™½å±ï¼‰
    const LucideIcon = ({ name, size = 16, style = {} }) => {
      const icons = {
        'layout-grid': (  // ç½‘æ ¼å›¾æ ‡ï¼ˆçƒŸéœé˜ï¼‰
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <rect x="3" y="3" width="7" height="7" />
            <rect x="14" y="3" width="7" height="7" />
            <rect x="3" y="14" width="7" height="7" />
            <rect x="14" y="14" width="7" height="7" />
          </svg>
        ),
        'bookmark': (  // æœªæ”¶è—ä¹¦ç­¾
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="m19 21-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
          </svg>
        ),
        'bookmark-check': (  // å·²æ”¶è—ä¹¦ç­¾ + å‹¾
          <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
            <path d="m19 21-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z" />
            <polyline points="9 11 12 14 22 4" />
          </svg>
        )
      };

      return (
        <span style={{ display: 'inline-block', verticalAlign: 'middle', lineHeight: 0, ...style }}>
          {icons[name] || icons['layout-grid']}
        </span>
      );
    };

    // API é…ç½®
    const API_CONFIG = {
      apiKey: 'hk-emzmdm100001546880118f3e8611dc35e14abc9adb46e5f7',
      baseURL: 'https://api.openai-hk.com',
      model: 'gpt-3.5-turbo',
      imageModel: 'dall-e-3'
    };

    // é€šç”¨ API è°ƒç”¨å‡½æ•°
    const callAPI = async (messages, maxTokens = 2000) => {
      try {
        const response = await fetch(`${API_CONFIG.baseURL}/v1/chat/completions`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${API_CONFIG.apiKey}`
          },
          body: JSON.stringify({
            model: API_CONFIG.model,
            max_tokens: maxTokens,
            messages: messages
          })
        });

        if (!response.ok) {
          throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        return data.choices[0].message.content;
      } catch (error) {
        console.error('APIè°ƒç”¨é”™è¯¯:', error);
        throw error;
      }
    };

    // ç”Ÿæˆå›¾ç‰‡çš„ API è°ƒç”¨
    const generateImage = async (prompt) => {
      try {
        const response = await fetch(`${API_CONFIG.baseURL}/v1/images/generations`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${API_CONFIG.apiKey}`
          },
          body: JSON.stringify({
            model: API_CONFIG.imageModel,
            prompt: prompt,
            n: 1,
            size: "1024x1024",
            style: "natural"
          })
        });

        if (!response.ok) {
          throw new Error(`å›¾ç‰‡ç”ŸæˆAPIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}`);
        }

        const data = await response.json();
        return data.data[0].url;
      } catch (error) {
        console.error('å›¾ç‰‡ç”Ÿæˆé”™è¯¯:', error);
        throw error;
      }
    };

    // æ¨èè¯—è¯
    const recommendPoem = async (feeling) => {
      const messages = [
        {
          role: "system",
          content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¸­å›½å¤è¯—è¯æ¨èåŠ©æ‰‹ï¼Œèƒ½å¤Ÿæ ¹æ®ç”¨æˆ·çš„æƒ…æ„ŸçŠ¶æ€æ¨èæœ€åˆé€‚çš„å¤è¯—è¯ã€‚"
        },
        {
          role: "user",
          content: `ç”¨æˆ·çš„éšç§˜æ„Ÿå—ï¼š"${feeling}"

è¯·ä¸ºTAæ¨èä¸€é¦–æœ€èƒ½å…±é¸£çš„ä¸­å›½å¤è¯—è¯ã€‚è¦æ±‚ï¼š
1. é€‰æ‹©çœŸå®å­˜åœ¨çš„å¤è¯—è¯ï¼ˆå”è¯—å®‹è¯ä¸ºä¸»ï¼‰
2. å¿…é¡»èƒ½ä¸ç”¨æˆ·çš„æ„Ÿå—äº§ç”Ÿæ·±åº¦å…±é¸£
3. å›å¤æ ¼å¼å¿…é¡»æ˜¯çº¯JSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ï¼š
{
  "title": "è¯—è¯æ ‡é¢˜",
  "author": "ä½œè€…ï¼ˆæœä»£ï¼‰",
  "content": "å®Œæ•´è¯—è¯æ­£æ–‡ï¼Œç”¨\\nåˆ†éš”æ¯ä¸€å¥",
  "reason": "ä¸ºä»€ä¹ˆè¿™é¦–è¯—èƒ½ä¸TAçš„æ„Ÿå—å…±é¸£ï¼Ÿç”¨ä¸€æ®µæ¸©æŸ”çš„è¯è§£é‡Šï¼ˆ50å­—ä»¥å†…ï¼‰}

DO NOT OUTPUT ANYTHING OTHER THAN VALID JSON.`
        }
      ];
      
      return await callAPI(messages, 2000);
    };

    // ç”Ÿæˆæ’ç”»æè¿°
    const generatePainting = async (poem) => {
      const messages = [
        {
          role: "system",
          content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¸­å›½æ°´å¢¨ç”»æè¿°å¸ˆï¼Œèƒ½å¤Ÿæ ¹æ®å¤è¯—è¯åˆ›ä½œå‡ºå¯Œæœ‰æ„å¢ƒçš„ç”»é¢æè¿°ã€‚"
        },
        {
          role: "user",
          content: `è¿™é¦–è¯—ï¼š
ã€Š${poem.title}ã€‹
${poem.author}

${poem.content}

è¯·ç”¨æ–‡å­—æç»˜ä¸€å¹…ä¸æ­¤è¯—æ„å¢ƒç›¸é…çš„æ°´å¢¨ç”»é¢ï¼Œè¦ï¼š
1. å…·ä½“çš„è§†è§‰åœºæ™¯ï¼ˆ100-150å­—ï¼‰
2. æ¸©æŸ”ã€å¤æ„ã€ç•™ç™½
3. ä¸è¦è¯´æ•™ï¼Œåªæç»˜ç”»é¢æœ¬èº«

ç›´æ¥è¾“å‡ºç”»é¢æè¿°ï¼Œä¸è¦æœ‰"è¿™å¹…ç”»"ã€"ç”»é¢ä¸­"ç­‰å‰ç¼€ã€‚`
        }
      ];
      
      return await callAPI(messages, 1500);
    };

    // ç”Ÿæˆæ–‡åŒ–èƒŒæ™¯
    const showBackground = async (poem) => {
      const messages = [
        {
          role: "system",
          content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¸­å›½å¤è¯—è¯æ–‡åŒ–ç ”ç©¶è€…ï¼Œèƒ½å¤Ÿæä¾›è¯—è¯çš„æ–‡åŒ–èƒŒæ™¯å’Œå…¸æ•…è§£é‡Šã€‚"
        },
        {
          role: "user",
          content: `è¿™é¦–è¯—ï¼š
ã€Š${poem.title}ã€‹
${poem.author}

${poem.content}

è¯·æä¾›å¿…è¦çš„æ–‡åŒ–èƒŒæ™¯å’Œå…¸æ•…è§£é‡Šï¼Œè¦ï¼š
1. åˆ›ä½œèƒŒæ™¯ï¼ˆå¦‚æœæœ‰ï¼‰
2. é‡è¦æ„è±¡æˆ–å…¸æ•…çš„è§£é‡Š
3. è¿™é¦–è¯—åœ¨æ–‡å­¦å²ä¸Šçš„ç‹¬ç‰¹ä¹‹å¤„

ç”¨æ¸©æŸ”ã€è€ƒå¤å¼çš„è¯­æ°”ï¼Œ200å­—ä»¥å†…ã€‚ä¸è¦ç”Ÿç¡¬çš„æ¡ç›®å¼ï¼Œè¦åƒåœ¨è®²æ•…äº‹ã€‚`
        }
      ];
      
      return await callAPI(messages, 1500);
    };

    // ç”Ÿæˆå±±æ²³å¿—
    const generateShanhe = async (poem) => {
      const messages = [
        {
          role: "system",
          content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ä¸­å›½å¤è¯—è¯åœ°ç†å’Œé£ç‰©ç ”ç©¶è€…ï¼Œèƒ½å¤Ÿæ ¹æ®è¯—è¯ç”Ÿæˆç›¸å…³çš„åœ°ç†ã€ç‰©å€™å’Œé£åœŸä¿¡æ¯ã€‚"
        },
        {
          role: "user",
          content: `è¿™é¦–è¯—ï¼š
ã€Š${poem.title}ã€‹
${poem.author}

${poem.content}

è¯·ç”Ÿæˆ3-4å¼ é£ç‰©å¡ç‰‡ï¼Œæ ¼å¼å¿…é¡»æ˜¯çº¯JSONï¼š
{
  "cards": [
    {
      "type": "åœ°ç†",
      "title": "å¡ç‰‡æ ‡é¢˜ï¼ˆå¦‚ï¼šé•¿å®‰åŸï¼‰",
      "content": "60-80å­—æè¿°",
      "tags": ["æ ‡ç­¾"]
    },
    {
      "type": "ç‰©å€™",
      "title": "å¡ç‰‡æ ‡é¢˜ï¼ˆå¦‚ï¼šæ˜¥åˆ†ï¼‰",
      "content": "60-80å­—æè¿°",
      "tags": ["æ ‡ç­¾"]
    },
    {
      "type": "é£åœŸ",
      "title": "å¡ç‰‡æ ‡é¢˜ï¼ˆå¦‚ï¼šé€åˆ«æ–‡åŒ–ï¼‰",
      "content": "60-80å­—æè¿°",
      "tags": ["æ ‡ç­¾"]
    }
  ]
}

DO NOT OUTPUT ANYTHING OTHER THAN VALID JSON.`
        }
      ];
      
      return await callAPI(messages, 2500);
    };

    // ç”Ÿæˆè¯—äººæ¥ä¿¡
    const startDialogue = async (userInput, poem) => {
      const messages = [
        {
          role: "system",
          content: "ä½ æ˜¯ä¸€ä¸ªèƒ½å¤Ÿæ¨¡ä»¿å¤ä»£è¯—äººè¯­æ°”çš„AIåŠ©æ‰‹ï¼Œèƒ½å¤Ÿä»¥è¯—äººçš„å£å»ç»™ç”¨æˆ·å†™ä¸€å°æ¸©æŸ”çš„æ¥ä¿¡ã€‚"
        },
        {
          role: "user",
          content: `ç”¨æˆ·çš„éšç§˜æ„Ÿå—ï¼š"${userInput || 'ä¸€ç§è¯´ä¸æ¸…çš„æƒ…ç»ª'}"

è¿™é¦–è¯—ä¸TAå…±é¸£ï¼š
ã€Š${poem.title}ã€‹
${poem.author}

${poem.content}

è¯·ä»¥è¯—äºº${poem.author}çš„å£å»ï¼Œç»™ç”¨æˆ·å†™ä¸€å°æ¸©æŸ”çš„æ¥ä¿¡ï¼ˆ150-200å­—ï¼‰ï¼ŒåŒ…å«ï¼š
1. ä½ çœ‹åˆ°äº†TAèº«ä¸Šçš„ä»€ä¹ˆç‰¹è´¨ï¼ˆä»TAçš„æ„Ÿå—ä¸­çœ‹åˆ°çš„ï¼‰
2. è¿™ä»½ç‰¹è´¨å¦‚ä½•ä¸è¿™é¦–è¯—ç›¸è¿
3. ä¸€å¥è·¨è¶Šæ—¶ç©ºçš„å…±é¸£æˆ–é¼“åŠ±

è¦æ±‚ï¼š
- åƒæ˜¯ä¸¤ä¸ªçµé­‚çš„å¯¹è¯ï¼Œä¸è¦è¯´æ•™
- ç”¨"ä½ "ç§°å‘¼ç”¨æˆ·
- æ¸©æš–ã€è¯—æ„ã€ç§å¯†
- è¦è®©ç”¨æˆ·è§‰å¾—"è¢«çœ‹è§äº†"

ç›´æ¥è¾“å‡ºæ¥ä¿¡å†…å®¹ï¼Œä¸è¦æœ‰"äº²çˆ±çš„"ã€"æ­¤è‡´"ç­‰æ ¼å¼ã€‚`
        }
      ];
      
      return await callAPI(messages, 2000);
    };

    // ç”Ÿæˆå›¾ç‰‡æç¤ºè¯
    const generateImagePrompt = async (poem, paintingDescription) => {
      const messages = [
        {
          role: "system",
          content: "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„AIå›¾ç‰‡æç¤ºè¯ç”Ÿæˆå™¨ï¼Œèƒ½å¤Ÿå°†ä¸­å›½å¤è¯—è¯å’Œæ°´å¢¨ç”»æè¿°è½¬æ¢ä¸ºé€‚åˆDALL-Eç”Ÿæˆçš„è‹±æ–‡æç¤ºè¯ã€‚"
        },
        {
          role: "user",
          content: `åŸºäºè¿™é¦–ä¸­å›½å¤è¯—è¯ï¼š
ã€Š${poem.title}ã€‹
${poem.author}

${poem.content}

å’Œè¿™æ®µæ°´å¢¨ç”»æè¿°ï¼š
${paintingDescription}

è¯·ç”Ÿæˆä¸€ä¸ªç®€æ´çš„è‹±æ–‡æç¤ºè¯ï¼ˆä¸è¶…è¿‡100è¯ï¼‰ï¼Œç”¨äºDALL-Eç”Ÿæˆä¸­å›½æ°´å¢¨é£æ ¼å›¾ç‰‡ã€‚è¦æ±‚ï¼š
1. çªå‡ºä¸­å›½æ°´å¢¨ç”»é£æ ¼
2. åŒ…å«è¯—ä¸­çš„ä¸»è¦æ„è±¡
3. ä¿æŒç®€æ´å’Œè¯—æ„
4. åªè¿”å›æç¤ºè¯ï¼Œä¸è¦æœ‰å…¶ä»–æ–‡å­—`
        }
      ];
      
      return await callAPI(messages, 500);
    };

    const App = () => {
      const [stage, setStage] = useState('input'); // input, poem, painting, background, shanhe, dialogue, analysis, gallery
      const [userInput, setUserInput] = useState('');
      const [poem, setPoem] = useState(null);
      const [loading, setLoading] = useState(false);
      const [painting, setPainting] = useState(null);
      const [paintingImage, setPaintingImage] = useState(null);
      const [background, setBackground] = useState(null);
      const [shanheCards, setShanheCards] = useState([]);
      const [analysis, setAnalysis] = useState('');
      
      // æ”¶è—ç›¸å…³
      const [savedPoems, setSavedPoems] = useState([]);
      const [savedCards, setSavedCards] = useState([]);
      const [galleryTab, setGalleryTab] = useState('poems');
      
      // ä»localStorageåŠ è½½
      useEffect(() => {
        try {
          const poems = localStorage.getItem('è¯—éš_ç¬ºä¸­è¯—');
          const cards = localStorage.getItem('è¯—éš_å±±æ²³å¿—');
          if (poems) setSavedPoems(JSON.parse(poems));
          if (cards) setSavedCards(JSON.parse(cards));
        } catch (e) {
          console.error("åŠ è½½localStorageå¤±è´¥:", e);
        }
      }, []);
      
      // ä¿å­˜åŠŸèƒ½
      const toggleSavePoem = () => {
        if (!poem) return;
        const isSaved = savedPoems.some(p => p.title === poem.title && p.author === poem.author);
        let newSaved;
        if (isSaved) {
          newSaved = savedPoems.filter(p => !(p.title === poem.title && p.author === poem.author));
        } else {
          newSaved = [...savedPoems, { ...poem, savedAt: new Date().toISOString() }];
        }
        setSavedPoems(newSaved);
        localStorage.setItem('è¯—éš_ç¬ºä¸­è¯—', JSON.stringify(newSaved));
      };
      
      const saveCard = (card) => {
        const cardWithMeta = { ...card, poemTitle: poem.title, poemAuthor: poem.author, savedAt: new Date().toISOString() };
        const newSaved = [...savedCards, cardWithMeta];
        setSavedCards(newSaved);
        localStorage.setItem('è¯—éš_å±±æ²³å¿—', JSON.stringify(newSaved));
      };
      
      const isPoemSaved = () => poem && savedPoems.some(p => p.title === poem.title && p.author === poem.author);
      const isCardSaved = (card) => savedCards.some(c => c.type === card.type && c.title === card.title && c.poemTitle === poem?.title);
      
      const getStats = () => {
        const locations = new Set(savedCards.filter(c => c.type === 'åœ°ç†').map(c => c.title));
        const seasons = new Set(savedCards.filter(c => c.type === 'ç‰©å€™').map(c => c.title));
        return { poemsCount: savedPoems.length, cardsCount: savedCards.length, locationsCount: locations.size, seasonsCount: seasons.size };
      };
      const stats = getStats();

      // é‡å¯å‡½æ•°ï¼ˆè¡¥å…¨ç¼ºå¤±ï¼‰
      const restart = () => {
        setStage('input');
        setUserInput('');
        setPoem(null);
        setLoading(false);
        setPainting(null);
        setPaintingImage(null);
        setBackground(null);
        setShanheCards([]);
        setAnalysis('');
      };

      // æ¨èè¯—è¯
      const handleRecommendPoem = async (feeling) => {
        setLoading(true);
        try {
          const responseText = await recommendPoem(feeling);
          let cleanResponse = responseText.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
          const poemData = JSON.parse(cleanResponse);
          setPoem(poemData);
          setStage('poem');
        } catch (error) {
          console.error('æ¨èè¯—è¯å¤±è´¥:', error);
          alert('æ¨èè¿‡ç¨‹é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè¯·é‡è¯•');
        }
        setLoading(false);
      };

      // ç”Ÿæˆæ’ç”»
      const handleGeneratePainting = async () => {
        setLoading(true);
        setStage('painting');
        setPaintingImage(null); // é‡ç½®å›¾ç‰‡
        
        try {
          // 1. ç”Ÿæˆæ–‡å­—æè¿°
          const paintingText = await generatePainting(poem);
          setPainting(paintingText);
          
          // 2. ç”Ÿæˆå›¾ç‰‡æç¤ºè¯
          const imagePrompt = await generateImagePrompt(poem, paintingText);
          
          // 3. ç”Ÿæˆå›¾ç‰‡
          try {
            const imageUrl = await generateImage(imagePrompt);
            setPaintingImage(imageUrl);
          } catch (imageError) {
            console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', imageError);
            // å›¾ç‰‡ç”Ÿæˆå¤±è´¥ä¸å½±å“æ–‡å­—æè¿°çš„æ˜¾ç¤º
          }
        } catch (error) {
          console.error('ç”Ÿæˆæ’ç”»å¤±è´¥:', error);
          alert('å…¥ç”»è¿‡ç¨‹é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè¯·é‡è¯•');
          setStage('poem');
        }
        setLoading(false);
      };

      // å±•ç¤ºæ–‡åŒ–èƒŒæ™¯
      const handleShowBackground = async () => {
        setLoading(true);
        setStage('background');
        try {
          const backgroundText = await showBackground(poem);
          setBackground(backgroundText);
        } catch (error) {
          console.error('å¯»è¿¹å¤±è´¥:', error);
          alert('å¯»è¿¹è¿‡ç¨‹é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè¯·é‡è¯•');
          setStage('poem');
        }
        setLoading(false);
      };

      // ç”Ÿæˆå±±æ²³å¿—
      const handleGenerateShanhe = async () => {
        setLoading(true);
        setStage('shanhe');
        try {
          const shanheResponse = await generateShanhe(poem);
          let cleanShanhe = shanheResponse.replace(/```json\n?/g, "").replace(/```\n?/g, "").trim();
          const shanheData = JSON.parse(cleanShanhe);
          setShanheCards(shanheData.cards || []);
        } catch (error) {
          console.error('å±±æ²³å¿—ç”Ÿæˆå¤±è´¥:', error);
          alert('å±±æ²³å¿—ç”Ÿæˆé‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè¯·é‡è¯•');
          setStage('poem');
        }
        setLoading(false);
      };

      // å¼€å§‹å¯¹è¯
      const handleStartDialogue = async () => {
        setLoading(true);
        setStage('dialogue');
        try {
          const letterText = await startDialogue(userInput, poem);
          setAnalysis(letterText);
          setStage('analysis');
        } catch (error) {
          console.error('æ¥ä¿¡ç”Ÿæˆå¤±è´¥:', error);
          alert('æ¥ä¿¡ç”Ÿæˆé‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œè¯·é‡è¯•');
          setStage('poem');
        }
        setLoading(false);
      };

      // ç”»å»Šåˆ‡æ¢ï¼ˆè¡¥å…¨ç¼ºå¤±ï¼‰
      const handleGalleryTab = (tab) => {
        setGalleryTab(tab);
      };

      return (
        <div style={{ padding: '40px 20px', maxWidth: '800px', margin: '0 auto', width: '100%' }}>
          {/* æ ‡é¢˜ */}
          <h1 style={{ textAlign: 'center', fontSize: '36px', letterSpacing: '8px', color: '#3A3A3A', marginBottom: '20px', cursor: 'pointer' }} onClick={restart}>
            è¯—éš
          </h1>

          {/* è¾“å…¥é˜¶æ®µ */}
          {stage === 'input' && (
            <div style={{ textAlign: 'center' }}>
              <textarea
                value={userInput}
                onChange={(e) => setUserInput(e.target.value)}
                placeholder="è¯´è¯´ä½ æœ€è¿‘çš„ä¸€ä¸ªéšç§˜æ„Ÿå—..."
                style={{
                  width: '100%',
                  height: '120px',
                  padding: '20px',
                  fontSize: '16px',
                  border: '1px solid #E5E5E5',
                  borderRadius: '8px',
                  resize: 'vertical',
                  boxSizing: 'border-box',
                  fontFamily: 'inherit'
                }}
              />
              <div style={{ marginTop: '30px', display: 'flex', gap: '15px', justifyContent: 'center' }}>
                <button
                  onClick={() => handleRecommendPoem(userInput)}
                  disabled={!userInput.trim() || loading}
                  style={{
                    padding: '12px 24px',
                    fontSize: '14px',
                    color: '#F8F6F1',
                    backgroundColor: loading ? '#AAAAAA' : '#8B9D83',
                    border: 'none',
                    borderRadius: '20px',
                    cursor: loading ? 'not-allowed' : 'pointer',
                    letterSpacing: '1px'
                  }}
                >
                  {loading ? <span className="loading-spinner" /> : ''} å¯»ä¸€é¦–è¯—
                </button>
                <button
                  onClick={() => handleRecommendPoem('éšæœºä¸€é¦–')}
                  disabled={loading}
                  style={{
                    padding: '12px 24px',
                    fontSize: '14px',
                    color: '#3A3A3A',
                    backgroundColor: 'transparent',
                    border: '1px solid #8B9D83',
                    borderRadius: '20px',
                    cursor: 'pointer',
                    letterSpacing: '1px'
                  }}
                >
                  éšç¼˜ä¸€é¦–
                </button>
              </div>
            </div>
          )}

          {/* è¯—è¯é˜¶æ®µ */}
          {stage === 'poem' && poem && (
            <div>
              <div style={{ textAlign: 'center', backgroundColor: 'rgba(255,255,255,0.7)', padding: '40px', borderRadius: '12px', marginBottom: '30px' }}>
                <h2 style={{ letterSpacing: '3px', color: '#3A3A3A' }}>{poem.title}</h2>
                <p style={{ color: '#8B9D83', fontSize: '14px' }}>{poem.author}</p>
                <div style={{ fontSize: '18px', lineHeight: '2.2', whiteSpace: 'pre-line' }}>{poem.content}</div>
                <p style={{ fontStyle: 'italic', color: '#6B6B6B', marginTop: '20px' }}>{poem.reason}</p>
              </div>
              <div style={{ display: 'flex', gap: '12px', justifyContent: 'center', flexWrap: 'wrap' }}>
                <button onClick={handleGeneratePainting} disabled={loading} style={{ padding: '10px 20px', fontSize: '14px', color: '#3A3A3A', backgroundColor: 'transparent', border: '1px solid #8B9D83', borderRadius: '20px', cursor: 'pointer', letterSpacing: '1px' }}>
                  å…¥ç”» ğŸ¨
                </button>
                <button onClick={handleShowBackground} disabled={loading} style={{ padding: '10px 20px', fontSize: '14px', color: '#3A3A3A', backgroundColor: 'transparent', border: '1px solid #8B9D83', borderRadius: '20px', cursor: 'pointer', letterSpacing: '1px' }}>
                  å¯»è¿¹ ğŸ“–
                </button>
                <button onClick={handleGenerateShanhe} disabled={loading} style={{ padding: '10px 20px', fontSize: '14px', color: '#3A3A3A', backgroundColor: 'transparent', border: '1px solid #8B9D83', borderRadius: '20px', cursor: 'pointer', letterSpacing: '1px' }}>
                  å±±æ²³å¿— ğŸ—ºï¸
                </button>
                <button onClick={handleStartDialogue} style={{ padding: '10px 20px', fontSize: '14px', color: '#F8F6F1', backgroundColor: '#8B9D83', border: '1px solid #8B9D83', borderRadius: '20px', cursor: 'pointer', letterSpacing: '1px' }}>
                  ä¸ä¹‹å…±é¥® ğŸ’¬
                </button>
              </div>
              <button onClick={toggleSavePoem} style={{ position: 'absolute', top: '20px', right: '20px', background: 'none', border: 'none', cursor: 'pointer' }}>
                <LucideIcon name={isPoemSaved() ? 'bookmark-check' : 'bookmark'} size={24} />
              </button>
            </div>
          )}

          {/* å…¥ç”»ç»“æœ */}
          {stage === 'painting' && (
            <div style={{
              animation: 'fadeIn 1s ease-in',
              backgroundColor: 'rgba(255,255,255,0.5)',
              padding: '30px',
              borderRadius: '12px',
              marginBottom: '30px',
              lineHeight: '1.9',
              color: '#3A3A3A',
              fontSize: '16px'
            }}>
              {loading ? (
                <p style={{
                  textAlign: 'center',
                  color: '#8B9D83',
                  fontSize: '14px',
                  letterSpacing: '2px',
                  padding: '20px 0'
                }}>
                  <span className="loading-spinner"></span>
                  æ­£åœ¨å…¥ç”»...
                </p>
              ) : (
                <>
                  {painting}
                  {paintingImage && (
                    <img 
                      src={paintingImage} 
                      alt="è¯—æ„æ’ç”»" 
                      className="painting-image"
                      style={{
                        width: '100%',
                        maxWidth: '400px',
                        display: 'block',
                        margin: '20px auto 0',
                        borderRadius: '8px',
                        boxShadow: '0 4px 12px rgba(0,0,0,0.1)'
                      }}
                    />
                  )}
                </>
              )}
            </div>
          )}

          {/* å¯»è¿¹ç»“æœ */}
          {stage === 'background' && (
            <div style={{
              animation: 'fadeIn 1s ease-in',
              backgroundColor: 'rgba(255,255,255,0.5)',
              padding: '30px',
              borderRadius: '12px',
              marginBottom: '30px',
              lineHeight: '1.9',
              color: '#3A3A3A',
              fontSize: '15px'
            }}>
              {loading ? (
                <p style={{
                  textAlign: 'center',
                  color: '#8B9D83',
                  fontSize: '14px',
                  letterSpacing: '2px',
                  padding: '20px 0'
                }}>
                  <span className="loading-spinner"></span>
                  æ­£åœ¨å¯»è¿¹...
                </p>
              ) : (
                background
              )}
            </div>
          )}

          {/* å±±æ²³å¿—å¡ç‰‡ */}
          {stage === 'shanhe' && (
            <div style={{ animation: 'fadeIn 1s ease-in' }}>
              {loading ? (
                <p style={{ textAlign: 'center', color: '#8B9D83', fontSize: '14px', letterSpacing: '2px', padding: '40px 0' }}>
                  <span className="loading-spinner"></span>
                  æ­£åœ¨ç»˜åˆ¶å±±æ²³...
                </p>
              ) : (
                <div style={{ display: 'grid', gridTemplateColumns: '1fr', gap: '20px', marginBottom: '30px' }}>
                  {shanheCards.map((card, idx) => (
                    <div key={idx} style={{ backgroundColor: 'rgba(255,255,255,0.7)', padding: '25px', borderRadius: '12px', border: '1px solid #E5E5E5', position: 'relative' }}>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '15px' }}>
                        <span style={{ fontSize: '24px' }}>{card.type === 'åœ°ç†' ? 'ğŸ“' : card.type === 'ç‰©å€™' ? 'ğŸŒ¸' : 'ğŸ›ï¸'}</span>
                        <div style={{ flex: 1 }}>
                          <span style={{ fontSize: '12px', color: '#8B9D83', backgroundColor: 'rgba(139,157,131,0.1)', padding: '3px 10px', borderRadius: '4px', marginRight: '10px' }}>{card.type}</span>
                          <span style={{ fontSize: '16px', color: '#3A3A3A', fontWeight: 'normal', letterSpacing: '1px' }}>{card.title}</span>
                        </div>
                      </div>
                      <p style={{ fontSize: '15px', color: '#6B6B6B', lineHeight: '1.9', marginBottom: '15px' }}>{card.content}</p>
                      {card.tags && card.tags.length > 0 && (
                        <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '15px' }}>
                          {card.tags.map((tag, tagIdx) => (
                            <span key={tagIdx} style={{ fontSize: '12px', color: '#8B9D83', backgroundColor: 'rgba(139,157,131,0.05)', padding: '4px 10px', borderRadius: '12px', border: '1px solid rgba(139,157,131,0.2)' }}>{tag}</span>
                          ))}
                        </div>
                      )}
                      <button onClick={() => saveCard(card)} disabled={isCardSaved(card)} style={{ fontSize: '13px', color: isCardSaved(card) ? '#AAAAAA' : '#8B9D83', backgroundColor: 'transparent', border: `1px solid ${isCardSaved(card) ? '#E5E5E5' : '#8B9D83'}`, padding: '6px 16px', borderRadius: '16px', cursor: isCardSaved(card) ? 'not-allowed' : 'pointer', transition: 'all 0.3s', letterSpacing: '1px', display: 'flex', alignItems: 'center', gap: '6px' }}>
                        <LucideIcon name={isCardSaved(card) ? 'bookmark-check' : 'bookmark'} size={14} />
                        {isCardSaved(card) ? 'å·²æ”¶è—' : 'æ”¶å…¥å±±æ²³'}
                      </button>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* å…±é¥®å¯¹è¯ - ç­‰å¾…æ¥ä¿¡ */}
          {stage === 'dialogue' && (
            <div style={{
              animation: 'fadeIn 1s ease-in',
              textAlign: 'center',
              padding: '60px 20px'
            }}>
              <p style={{
                fontSize: '16px',
                color: '#8B9D83',
                letterSpacing: '3px',
                marginBottom: '20px'
              }}>
                <span className="loading-spinner"></span>
                {poem.author.split('ï¼ˆ')[0]}æ­£åœ¨æç¬”...
              </p>
              <p style={{
                fontSize: '14px',
                color: '#AAAAAA',
                letterSpacing: '2px'
              }}>
                ç©¿è¶Šæ—¶ç©ºçš„æ¥ä¿¡ï¼Œå³å°†æŠµè¾¾
              </p>
            </div>
          )}

          {/* è¯—äººæ¥ä¿¡ */}
          {stage === 'analysis' && analysis && (
            <div style={{
              animation: 'fadeIn 1.5s ease-in'
            }}>
              <div style={{
                backgroundColor: 'rgba(139,157,131,0.1)',
                padding: '35px',
                borderRadius: '12px',
                lineHeight: '2',
                color: '#3A3A3A',
                fontSize: '16px',
                marginBottom: '30px',
                borderLeft: '3px solid #8B9D83'
              }}>
                {analysis}
              </div>
              
              <p style={{
                textAlign: 'right',
                color: '#8B9D83',
                fontSize: '14px',
                fontStyle: 'italic',
                marginBottom: '30px'
              }}>
                â€”â€” {poem.author}
              </p>
            </div>
          )}

          {/* è¿”å›æŒ‰é’® */}
          {(stage === 'painting' || stage === 'background' || stage === 'shanhe' || stage === 'analysis') && (
            <div style={{
              display: 'flex',
              gap: '15px',
              justifyContent: 'center',
              marginTop: '30px'
            }}>
              {(stage === 'painting' || stage === 'background' || stage === 'shanhe') && (
                <button
                  onClick={() => setStage('poem')}
                  style={{
                    padding: '10px 24px',
                    fontSize: '14px',
                    color: '#8B9D83',
                    backgroundColor: 'transparent',
                    border: '1px solid #8B9D83',
                    borderRadius: '20px',
                    cursor: 'pointer',
                    letterSpacing: '1px'
                  }}
                >
                  è¿”å›
                </button>
              )}
              
              <button
                onClick={restart}
                style={{
                  padding: '10px 24px',
                  fontSize: '14px',
                  color: '#8B9D83',
                  backgroundColor: 'transparent',
                  border: '1px solid #8B9D83',
                  borderRadius: '20px',
                  cursor: 'pointer',
                  letterSpacing: '1px'
                }}
              >
                å†å¯»ä¸€é¦–
              </button>
            </div>
          )}

          {/* CSS åŠ¨ç”» */}
          <style>{`
            @keyframes fadeIn {
              from {
                opacity: 0;
                transform: translateY(10px);
              }
              to {
                opacity: 1;
                transform: translateY(0);
              }
            }
            
            button:hover:not(:disabled) {
              opacity: 0.8;
              transform: translateY(-2px);
              box-shadow: 0 4px 12px rgba(139,157,131,0.3);
            }
            
            textarea:focus {
              outline: none;
              border-color: #8B9D83;
              box-shadow: 0 0 5px rgba(139, 157, 131, 0.3);
            }
            
            ::placeholder {
              color: #BBBBBB;
            }
          `}</style>
        </div>
      );
    };

    // å°† App ç»„ä»¶æ¸²æŸ“åˆ° root èŠ‚ç‚¹
    const container = document.getElementById('root');
    const root = ReactDOM.createRoot(container);
    root.render(<App />);
  </script>
</body>

</html>
