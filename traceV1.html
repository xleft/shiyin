<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trace - è®¤çŸ¥æ¼”åŒ–è½¨è¿¹</title>
    <!-- 1. å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. å¼•å…¥ PDF.js åº“ -->
    <!-- è¿™æ˜¯ pdf.js çš„æ ¸å¿ƒåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.min.js"></script>
    
    <style>
        /* ç®€å•çš„åŠ è½½åŠ¨ç”» */
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1.5s linear infinite;
        }
        /* æ‰“å°æ ·å¼ï¼šéšè—ä¸éœ€è¦æ‰“å°çš„å…ƒç´  */
        @media print {
            body { 
                background: white; 
                padding: 0;
                margin: 0;
            }
            .no-print { 
                display: none; 
            }
            /* ç¡®ä¿æ‰“å°æ—¶ç»“æœé¡µé¢å¯è§ä¸”æ ¼å¼æ­£ç¡® */
            #stage-result {
                display: block !important;
                visibility: visible !important;
                min-height: 0;
                background: white;
                padding: 0;
            }
            /* éšè—å…¶ä»–é¡µé¢ */
            #stage-upload, #stage-analyzing {
                display: none !important;
            }
            /* ç§»é™¤ç»“æœé¡µé¢çš„æ¸å˜èƒŒæ™¯ */
            .bg-gradient-to-br {
                background: white;
            }
            /* ç¡®ä¿å¡ç‰‡æœ‰è¾¹æ¡†ä»¥ä¾¿åŒºåˆ† */
            .shadow-lg {
                box-shadow: none;
                border: 1px solid #eee;
            }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- 
      ****************************************
      * é˜¶æ®µ 1: ä¸Šä¼ é¡µé¢
      ****************************************
    -->
    <div id="stage-upload" class="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center p-6">
      <div class="max-w-2xl w-full bg-white bg-opacity-95 backdrop-blur-lg rounded-3xl p-8 sm:p-12 shadow-2xl">
        <div class="text-center mb-8">
          <h1 class="text-5xl font-light text-gray-800 mb-4">Trace</h1>
          <p class="text-xl text-gray-600 font-light">çœ‹è§ä½ çš„è®¤çŸ¥æ¼”åŒ–è½¨è¿¹</p>
        </div>

        <div class="mb-8">
          <!-- å°† 'for' å±æ€§æŒ‡å‘ 'file-upload' -->
          <label for="file-upload" id="drop-zone" class="border-4 border-dashed border-purple-300 rounded-2xl p-12 text-center hover:border-purple-400 hover:bg-purple-50 transition-all cursor-pointer block">
            <!-- MODIFIED: æ¥å— .txt å’Œ .pdf -->
            <input type="file" accept=".txt,.pdf" class="hidden" id="file-upload" />
            <div class="text-6xl mb-4">ğŸ“¤</div>
            <p class="text-lg text-gray-700 mb-2">ä¸Šä¼ ä½ å’ŒAIçš„å¯¹è¯è®°å½•</p>
            <!-- MODIFIED: æ›´æ–°æç¤ºæ–‡æœ¬ -->
            <p class="text-sm text-gray-500 mb-3">æ”¯æŒ TXTã€PDF æ ¼å¼</p>
            <p class="text-xs text-gray-400 bg-purple-50 rounded-lg px-4 py-2 inline-block">
              ğŸ’¡ æç¤ºï¼šTXTæ–‡ä»¶è§£ææ•ˆæœæœ€ä½³<br/>
              æ–‡ä»¶å¤§å°å»ºè®®å°äº10MB
            </p>
          </label>
        </div>

        <div id="file-preview" class="hidden bg-purple-50 rounded-xl p-6 mb-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3 overflow-hidden">
              <div class="text-3xl flex-shrink-0">ğŸ“„</div>
              <div class="overflow-hidden">
                <p id="file-name" class="font-medium text-gray-800 truncate"></p>
                <p id="file-size" class="text-sm text-gray-500"></p>
              </div>
            </div>
            <button id="remove-file" class="text-gray-400 hover:text-gray-600 text-2xl flex-shrink-0 ml-2">âœ•</button>
          </div>
          
          <button id="analyze-button" class="w-full py-4 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl font-medium text-lg hover:shadow-lg transition-all disabled:opacity-75 disabled:cursor-not-allowed">
            å¼€å§‹è§£è¯»è®¤çŸ¥å†ç¨‹
          </button>
        </div>

        <div class="text-center text-sm text-gray-500">
          <p>Trace ä¼šå¸®ä½ è¯†åˆ«ï¼š</p>
          <div class="flex justify-center gap-4 sm:gap-6 mt-3 flex-wrap">
            <span>ğŸ¯ å…³é”®è½¬æŠ˜ç‚¹</span>
            <span>ğŸ’¡ æ ¸å¿ƒæ´å¯Ÿ</span>
            <span>ğŸŒ± è®¤çŸ¥çªç ´</span>
            <span>ğŸ”— æ¦‚å¿µå…³è”</span>
          </div>
        </div>
      </div>
    </div>

    <!-- 
      ****************************************
      * é˜¶æ®µ 2: åˆ†æä¸­é¡µé¢
      ****************************************
    -->
    <div id="stage-analyzing" class="hidden min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 flex items-center justify-center p-6">
      <div class="text-center">
        <div class="relative w-32 h-32 mx-auto mb-8">
          <div class="absolute inset-0 border-4 border-white border-t-transparent rounded-full animate-spin"></div>
          <div class="absolute inset-4 border-4 border-white border-b-transparent rounded-full animate-spin" style="animation-direction: reverse; animation-duration: 1s;"></div>
          <div class="absolute inset-0 flex items-center justify-center text-4xl">ğŸ§ </div>
        </div>
        <h2 class="text-3xl text-white font-light mb-4">Trace æ­£åœ¨è§£è¯»ä½ çš„è®¤çŸ¥å†ç¨‹...</h2>
        <div class="space-y-2 text-white text-opacity-80">
          <p>è¯†åˆ«å…³é”®è½¬æŠ˜ç‚¹</p>
          <p>æå–æ ¸å¿ƒæ¦‚å¿µ</p>
          <p>æ ‡æ³¨è®¤çŸ¥çªç ´</p>
          <p>æ„å»ºæ¼”åŒ–åœ°å›¾</p>
        </div>
      </div>
    </div>

    <!-- 
      ****************************************
      * é˜¶æ®µ 3: ç»“æœé¡µé¢
      ****************************************
    -->
    <div id="stage-result" class="hidden min-h-screen bg-gradient-to-br from-gray-50 to-purple-50 py-12 px-6">
        <!-- ç»“æœé¡µé¢çš„å†…å®¹ ... (æœªä¿®æ”¹) ... -->
        <div class="max-w-5xl mx-auto">
            <!-- å¤´éƒ¨ -->
            <div class="bg-white rounded-3xl p-8 shadow-lg mb-8">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
                <div class="mb-4 sm:mb-0">
                  <h1 class="text-3xl sm:text-4xl font-light text-gray-800 mb-2">
                    ä½ çš„è®¤çŸ¥æ¼”åŒ–è½¨è¿¹
                  </h1>
                  <p id="result-summary" class="text-gray-600"></p>
                </div>
                <div class="flex flex-col sm:flex-row gap-3 no-print">
                  <button id="export-html" class="px-5 py-3 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-xl hover:shadow-lg transition-all flex items-center justify-center gap-2" title="ä¸‹è½½ä¸ºHTMLæ–‡ä»¶">
                    <span>ğŸ“¥</span> <span>å¯¼å‡ºHTML</span>
                  </button>
                  <button id="export-pdf" class="px-5 py-3 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl hover:shadow-lg transition-all flex items-center justify-center gap-2" title="æ‰“å°æˆ–ä¿å­˜ä¸ºPDF">
                    <span>ğŸ“„</span> <span>å¯¼å‡ºPDF</span>
                  </button>
                  <button id="back-button" class="px-5 py-3 bg-purple-100 text-purple-600 rounded-xl hover:bg-purple-200 transition-all flex items-center justify-center gap-2">
                    <span>â†</span> <span>è¿”å›</span>
                  </button>
                </div>
              </div>
              <!-- ç»Ÿè®¡ -->
              <div class="grid grid-cols-3 gap-4">
                <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-4 text-center">
                  <div id="stats-phases" class="text-3xl font-light text-purple-600">0</div>
                  <div class="text-sm text-gray-600">æ€è€ƒé˜¶æ®µ</div>
                </div>
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-4 text-center">
                  <div id="stats-breakthroughs" class="text-3xl font-light text-blue-600">0</div>
                  <div class="text-sm text-gray-600">è®¤çŸ¥çªç ´</div>
                </div>
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-4 text-center">
                  <div id="stats-concepts" class="text-3xl font-light text-green-600">0</div>
                  <div class="text-sm text-gray-600">æ ¸å¿ƒæ¦‚å¿µ</div>
                </div>
              </div>
            </div>
            <!-- Timeline -->
            <div class="bg-white rounded-3xl p-6 sm:p-8 shadow-lg mb-8">
              <h2 class="text-2xl font-light text-gray-800 mb-6">æ€ç»´æ¼”åŒ–æ—¶é—´çº¿</h2>
              <div id="timeline-container" class="space-y-6">
                <!-- åŠ¨æ€å†…å®¹å°†å¡«å……åœ¨è¿™é‡Œ -->
              </div>
            </div>
            <!-- æ ¸å¿ƒæ¦‚å¿µ -->
            <div class="bg-white rounded-3xl p-6 sm:p-8 shadow-lg mb-8">
              <h2 class="text-2xl font-light text-gray-800 mb-6">æ ¸å¿ƒæ¦‚å¿µåº“</h2>
              <div id="concepts-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- åŠ¨æ€å†…å®¹å°†å¡«å……åœ¨è¿™é‡Œ -->
              </div>
            </div>
            <!-- è®¤çŸ¥è½¬å˜ -->
            <div id="shifts-wrapper" class="hidden bg-gradient-to-br from-purple-500 to-pink-500 rounded-3xl p-6 sm:p-8 shadow-lg mb-8 text-white">
              <h2 class="text-2xl font-light mb-6">å…³é”®è®¤çŸ¥è½¬å˜</h2>
              <div id="shifts-container" class="space-y-3">
                <!-- åŠ¨æ€å†…å®¹å°†å¡«å……åœ¨è¿™é‡Œ -->
              </div>
            </div>
            <!-- ä¸‹ä¸€æ­¥ -->
            <div class="bg-white rounded-3xl p-6 sm:p-8 shadow-lg">
              <h2 class="text-2xl font-light text-gray-800 mb-4">ğŸŒ± ç»§ç»­æ¢ç´¢</h2>
              <p id="next-steps" class="text-gray-700 leading-relaxed"></p>
            </div>
            <div class="text-center mt-8 text-gray-500 text-sm">
              <p>Trace - è®©æ¯æ¬¡å¯¹è¯éƒ½æˆä¸ºè®¤çŸ¥çš„å°é˜¶</p>
            </div>
          </div>
    </div>


    <!-- 
      ****************************************
      * 2. æ‰€æœ‰çš„ JavaScript é€»è¾‘
      ****************************************
    -->
    <script>
      // å…¨å±€å˜é‡æ¥å­˜å‚¨çŠ¶æ€å’Œæ•°æ®
      let currentStage = 'upload';
      let conversationText = '';
      let analysisResult = null;
      let currentFile = null;

      // API é…ç½®
      const API_URL = "https://api.openai-hk.com/v1/chat/completions";
      const API_KEY = "hk-jjgtjh1000015468211af701640e2afc1e374d7b8e511942";
      const API_MODEL = "gpt-4-turbo"; 

      // --- NEW PDF.js CONFIG ---
      // å‘Šè¯‰ pdf.js åº“åœ¨å“ªé‡ŒåŠ è½½ 'worker' è„šæœ¬
      // è¿™æ˜¯ pdf.js è¿è¡Œæ‰€å¿…éœ€çš„
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.6.347/pdf.worker.min.js';

      // è·å–æ‰€æœ‰é¡µé¢å…ƒç´ 
      const stageUpload = document.getElementById('stage-upload');
      const stageAnalyzing = document.getElementById('stage-analyzing');
      const stageResult = document.getElementById('stage-result');

      const dropZone = document.getElementById('drop-zone');
      const fileUpload = document.getElementById('file-upload');
      const filePreview = document.getElementById('file-preview');
      const fileNameEl = document.getElementById('file-name');
      const fileSizeEl = document.getElementById('file-size');
      const removeFileBtn = document.getElementById('remove-file');
      const analyzeButton = document.getElementById('analyze-button');
      const backButton = document.getElementById('back-button');
      const exportHtmlBtn = document.getElementById('export-html');
      const exportPdfBtn = document.getElementById('export-pdf');

      // åˆ‡æ¢é¡µé¢çš„è¾…åŠ©å‡½æ•°
      function showStage(stageName) {
        // æ˜¾å¼éšè—æ‰€æœ‰é˜¶æ®µ
        stageUpload.classList.add('hidden');
        stageUpload.style.display = 'none';
        
        stageAnalyzing.classList.add('hidden');
        stageAnalyzing.style.display = 'none';

        stageResult.classList.add('hidden');
        stageResult.style.display = 'none';

        // åªæ˜¾ç¤ºéœ€è¦çš„é˜¶æ®µ
        if (stageName === 'upload') {
          stageUpload.classList.remove('hidden');
          stageUpload.style.display = 'flex';
        } else if (stageName === 'analyzing') {
          stageAnalyzing.classList.remove('hidden');
          stageAnalyzing.style.display = 'flex';
        } else if (stageName === 'result') {
          stageResult.classList.remove('hidden');
          stageResult.style.display = 'block';
        }
        currentStage = stageName;
      }

      // --- NEW PDF PARSING FUNCTION ---
      async function readPdfText(arrayBuffer) {
        try {
          // åŠ è½½ PDF æ–‡æ¡£
          const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
          let allText = '';
          
          // å¾ªç¯éå†æ¯ä¸€é¡µ
          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            // å°†æ¯ä¸€é¡µçš„æ–‡æœ¬é¡¹è¿æ¥èµ·æ¥
            const pageText = textContent.items.map(item => item.str).join(' ');
            allText += pageText + '\n\n'; // åœ¨æ¯é¡µä¹‹é—´æ·»åŠ æ¢è¡Œ
          }
          
          return allText;
        } catch (error) {
          console.error('PDF è§£æå¤±è´¥:', error);
          throw new Error('PDF æ–‡ä»¶è§£æå¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½å·²æŸåæˆ–æ ¼å¼ä¸å—æ”¯æŒã€‚');
        }
      }
      // --- END NEW ---


      // --- MODIFIED handleFile FUNCTION ---
      async function handleFile(file) { // æ ‡è®°ä¸º async
        if (!file) return;

        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (file.type !== 'text/plain' && file.type !== 'application/pdf') {
          alert('æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒï¼Œè¯·ä¸Šä¼  .txt æˆ– .pdf æ–‡ä»¶');
          fileUpload.value = null; // æ¸…ç©ºè¾“å…¥
          return;
        }

        // æ£€æŸ¥æ–‡ä»¶å¤§å°
        if (file.size > 10 * 1024 * 1024) { // 10MB
          alert('æ–‡ä»¶è¶…è¿‡ 10MB å¤§å°é™åˆ¶ï¼Œè¯·é‡æ–°é€‰æ‹©ã€‚');
          fileUpload.value = null; // æ¸…ç©ºè¾“å…¥
          return;
        }

        currentFile = file;
        fileNameEl.textContent = file.name;
        fileSizeEl.textContent = (file.size / 1024).toFixed(1) + ' KB';
        filePreview.classList.remove('hidden');

        // ç¦ç”¨åˆ†ææŒ‰é’®ç›´åˆ°æ–‡ä»¶è¯»å–å®Œæ¯•
        analyzeButton.disabled = true;
        analyzeButton.textContent = 'æ­£åœ¨è¯»å–æ–‡ä»¶...';

        try {
          if (file.type === 'text/plain') {
            // è¯»å– TXT æ–‡ä»¶
            conversationText = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = (event) => resolve(event.target.result);
              reader.onerror = () => reject(new Error('TXT æ–‡ä»¶è¯»å–å¤±è´¥'));
              reader.readAsText(file);
            });
          } else if (file.type === 'application/pdf') {
            // 1. è¯»å– PDF æ–‡ä»¶ä¸º ArrayBuffer
            const arrayBuffer = await new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = (event) => resolve(event.target.result);
              reader.onerror = () => reject(new Error('PDF æ–‡ä»¶è¯»å–å¤±è´¥'));
              reader.readAsArrayBuffer(file);
            });
            
            // 2. è§£æ PDF æ–‡æœ¬
            conversationText = await readPdfText(arrayBuffer);
          }
          
          console.log('æ–‡ä»¶è¯»å–å®Œæˆï¼Œæ–‡æœ¬é•¿åº¦:', conversationText.length);
          if (conversationText.length < 50) {
              alert('ä»æ–‡ä»¶ä¸­è¯»å–çš„æ–‡æœ¬å†…å®¹è¿‡å°‘ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶ã€‚');
              resetUpload();
              return;
          }

          // æ¢å¤æŒ‰é’®
          analyzeButton.disabled = false;
          analyzeButton.textContent = 'å¼€å§‹è§£è¯»è®¤çŸ¥å†ç¨‹';

        } catch (error) {
          alert(error.message);
          resetUpload();
        }
      }
      // --- END MODIFIED ---

      // --- MODIFIED resetUpload FUNCTION ---
      function resetUpload() {
        currentFile = null;
        conversationText = '';
        analysisResult = null;
        fileUpload.value = null; // æ¸…ç©º input
        filePreview.classList.add('hidden');
        
        // ç¡®ä¿æŒ‰é’®åœ¨é‡ç½®æ—¶æ¢å¤æ­£å¸¸
        analyzeButton.disabled = false;
        analyzeButton.textContent = 'å¼€å§‹è§£è¯»è®¤çŸ¥å†ç¨‹';
      }
      // --- END MODIFIED ---


      // æ ¸å¿ƒï¼šåˆ†æå¯¹è¯
      async function analyzeConversation() {
        if (!conversationText || conversationText.length < 50) {
          alert('å¯¹è¯å†…å®¹å¤ªå°‘äº†ï¼Œè¯·ç¡®ä¿æ–‡ä»¶ä¸­æœ‰è¶³å¤Ÿçš„å¯¹è¯å†…å®¹');
          return;
        }

        // æˆªå–
        let textToAnalyze = conversationText;
        if (textToAnalyze.length > 20000) {
          textToAnalyze = textToAnalyze.substring(0, 20000);
          console.log('å¯¹è¯å¤ªé•¿ï¼Œå·²æˆªå–å‰20000å­—ç¬¦è¿›è¡Œåˆ†æ');
        }

        showStage('analyzing');

        try {
          console.log('å¼€å§‹åˆ†æï¼Œæ–‡æœ¬é•¿åº¦:', textToAnalyze.length);
          
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${API_KEY}`
            },
            body: JSON.stringify({
              model: API_MODEL,
              max_tokens: 4000,
              response_format: { type: "json_object" }, 
              messages: [
                {
                  role: "system",
                  content: `ä½ æ˜¯Trace - ä¸€ä¸ªAIè®¤çŸ¥å¤ç›˜åŠ©æ‰‹ã€‚ä½ çš„ä»»åŠ¡æ˜¯åˆ†æç”¨æˆ·ä¸Šä¼ çš„å¯¹è¯è®°å½•ï¼Œè¯†åˆ«è®¤çŸ¥æ¼”åŒ–çš„è¿‡ç¨‹ã€‚
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºåˆ†æç»“æœï¼š
{
  "summary": "è¿™æ®µå¯¹è¯çš„æ ¸å¿ƒä¸»é¢˜ï¼ˆ1-2å¥è¯ï¼‰",
  "phases": [
    {
      "title": "é˜¶æ®µæ ‡é¢˜",
      "type": "normal/breakthrough", 
      "content": "è¿™ä¸ªé˜¶æ®µå‘ç”Ÿäº†ä»€ä¹ˆ",
      "insights": ["å…³é”®æ´å¯Ÿ1", "å…³é”®æ´å¯Ÿ2"],
      "concepts": [{"name": "æ¦‚å¿µå", "description": "æ¦‚å¿µæè¿°"}]
    }
  ],
  "key_concepts": [
    {"term": "æ ¸å¿ƒæ¦‚å¿µ", "definition": "å®šä¹‰"}
  ],
  "cognitive_shifts": [
    "è®¤çŸ¥è½¬å˜1",
    "è®¤çŸ¥è½¬å˜2"
  ],
  "next_steps": "åŸºäºè¿™æ¬¡å¯¹è¯ï¼Œå¯èƒ½çš„ä¸‹ä¸€æ­¥æ¢ç´¢æ–¹å‘"
}
é‡ç‚¹ï¼š
1. è¯†åˆ«æ€ç»´çš„è½¬æŠ˜ç‚¹å’Œçªç ´ç‚¹ï¼ˆæ ‡è®°ä¸ºbreakthroughç±»å‹ï¼‰
2. æå–å¯å¤ç”¨çš„æ¦‚å¿µå’Œæ´å¯Ÿ
3. è‡³å°‘è¯†åˆ«3-5ä¸ªphases
4. è‡³å°‘æ ‡æ³¨1-2ä¸ªbreakthrough
CRITICAL: ä½ çš„å›å¤å¿…é¡»æ˜¯çº¯JSONæ ¼å¼ï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–æ–‡å­—ã€è§£é‡Šæˆ–markdownæ ‡è®°ã€‚`
                },
                {
                  role: "user",
                  content: `è¯·åˆ†æä»¥ä¸‹å¯¹è¯å†…å®¹ï¼š\n\n${textToAnalyze}`
                }
              ]
            })
          });

          console.log('APIå“åº”çŠ¶æ€:', response.status);

          if (!response.ok) {
            const errorData = await response.text();
            throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status} ${response.statusText}. è¯¦æƒ…: ${errorData}`);
          }

          const data = await response.json();
          console.log('æ”¶åˆ°APIå“åº”');
          
          let responseText = data.choices[0].message.content;
          
          console.log('åŸå§‹å“åº”:', responseText);
          
          if (responseText.includes('```json')) {
             responseText = responseText.split('```json\n')[1].split('\n```')[0];
          }
          
          if (!responseText.startsWith('{')) {
            const jsonStart = responseText.indexOf('{');
            if (jsonStart !== -1) {
              responseText = responseText.substring(jsonStart);
            }
          }
          
          try {
            analysisResult = JSON.parse(responseText);
            console.log('JSONè§£ææˆåŠŸ');
            renderResult(analysisResult);
            showStage('result');
          } catch (parseError) {
            console.error('JSONè§£æå¤±è´¥:', parseError);
            console.error('æ”¶åˆ°çš„éJSONå“åº”æ–‡æœ¬:', responseText);
            throw new Error('åˆ†æç»“æœæ ¼å¼æœ‰è¯¯ (APIæœªè¿”å›æ ‡å‡†JSON)ï¼Œè¯·é‡è¯•');
          }
        } catch (error) {
          console.error('åˆ†æå¤±è´¥è¯¦æƒ…:', error);
          alert(`åˆ†æè¿‡ç¨‹å‡ºç°é—®é¢˜ï¼š${error.message}\n\nå»ºè®®ï¼š\n1. ç¡®ä¿æ–‡ä»¶å†…å®¹æ˜¯å¯¹è¯æ–‡æœ¬\n2. æ£€æŸ¥æ‚¨çš„APIä»£ç†å’ŒKeyæ˜¯å¦æœ‰æ•ˆ`);
          showStage('upload');
        }
      }

      // æ¸²æŸ“ç»“æœé¡µé¢
      function renderResult(analysis) {
        // è¾…åŠ©å‡½æ•°ï¼šæ¸…ç†HTMLå†…å®¹ï¼Œé˜²æ­¢æ³¨å…¥
        const sanitize = (str) => {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        };

        document.getElementById('result-summary').textContent = analysis.summary || '';
        document.getElementById('stats-phases').textContent = analysis.phases?.length || 0;
        document.getElementById('stats-breakthroughs').textContent = analysis.phases?.filter(p => p.type === 'breakthrough').length || 0;
        document.getElementById('stats-concepts').textContent = analysis.key_concepts?.length || 0;
        document.getElementById('next-steps').textContent = analysis.next_steps || '';

        // æ¸²æŸ“æ—¶é—´çº¿
        const timelineContainer = document.getElementById('timeline-container');
        timelineContainer.innerHTML = ''; // æ¸…ç©º
        analysis.phases?.forEach((phase, index) => {
          const isBreakthrough = phase.type === 'breakthrough';
          
          const insightsHTML = (phase.insights || [])
            .map(insight => `<div class="bg-white bg-opacity-60 rounded-lg p-3 mb-2 text-sm text-gray-700 italic">"${sanitize(insight)}"</div>`)
            .join('');
            
          const conceptsHTML = (phase.concepts || [])
            .map(concept => `<div class="bg-white rounded-lg px-3 py-1 text-sm">
                              <span class="font-medium text-purple-600">${sanitize(concept.name)}</span>
                              <span class="text-gray-600"> - ${sanitize(concept.description)}</span>
                            </div>`)
            .join('');

          const phaseHTML = `
            <div class="relative pl-12">
              ${index < analysis.phases.length - 1 ? '<div class="absolute left-4 top-8 bottom-0 w-0.5 bg-gradient-to-b from-purple-300 to-pink-300"></div>' : ''}
              <div class="absolute left-0 top-2 w-8 h-8 rounded-full flex items-center justify-center text-white ${
                isBreakthrough 
                  ? 'bg-gradient-to-br from-pink-400 to-red-400 shadow-lg' 
                  : 'bg-gradient-to-br from-purple-400 to-indigo-400'
              }">
                ${isBreakthrough ? 'âš¡' : 'â—'}
              </div>
              <div class="rounded-xl p-6 ${
                isBreakthrough
                  ? 'bg-gradient-to-br from-pink-50 to-red-50 border-2 border-pink-200'
                  : 'bg-gray-50'
              }">
                <h3 class="text-xl font-medium mb-3 ${isBreakthrough ? 'text-pink-600' : 'text-gray-800'}">
                  ${isBreakthrough ? 'ğŸ’¡ ' : ''}${sanitize(phase.title)}
                </h3>
                <p class="text-gray-700 mb-4 whitespace-pre-wrap">${sanitize(phase.content)}</p>
                ${insightsHTML ? `<div class="mb-4"><div class="text-sm font-medium text-gray-600 mb-2">å…³é”®æ´å¯Ÿï¼š</div>${insightsHTML}</div>` : ''}
                ${conceptsHTML ? `<div class="flex flex-wrap gap-2">${conceptsHTML}</div>` : ''}
              </div>
            </div>`;
          timelineContainer.innerHTML += phaseHTML;
        });

        // æ¸²æŸ“æ¦‚å¿µåº“
        const conceptsContainer = document.getElementById('concepts-container');
        conceptsContainer.innerHTML = '';
        analysis.key_concepts?.forEach(concept => {
          conceptsContainer.innerHTML += `
            <div class="bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl p-5 border border-purple-100">
              <h3 class="font-medium text-purple-700 mb-2">${sanitize(concept.term)}</h3>
              <p class="text-sm text-gray-700">${sanitize(concept.definition)}</p>
            </div>`;
        });

        // æ¸²æŸ“è®¤çŸ¥è½¬å˜
        const shiftsWrapper = document.getElementById('shifts-wrapper');
        const shiftsContainer = document.getElementById('shifts-container');
        shiftsContainer.innerHTML = '';
        if (analysis.cognitive_shifts && analysis.cognitive_shifts.length > 0) {
          shiftsWrapper.classList.remove('hidden');
          analysis.cognitive_shifts.forEach(shift => {
            shiftsContainer.innerHTML += `
              <div class="bg-white bg-opacity-20 backdrop-blur-sm rounded-xl p-4 flex items-start gap-3">
                <span class="text-2xl">â†’</span>
                <p class="flex-1">${sanitize(shift)}</p>
              </div>`;
          });
        } else {
          shiftsWrapper.classList.add('hidden');
        }
      }
      
      // å¯¼å‡º HTML
      function exportAsHTML() {
        if (!analysisResult) return;
        
        // è¾…åŠ©å‡½æ•°ï¼šæ¸…ç†HTMLå†…å®¹ï¼Œé˜²æ­¢æ³¨å…¥
        const sanitize = (str) => {
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        };
        
        const resultHTML = document.getElementById('stage-result').innerHTML;
        
        // --- MODIFICATION ---
        // é€šè¿‡å­—ç¬¦ä¸²æ‹¼æ¥æ¥åˆ›å»º <script> æ ‡ç­¾ï¼Œé¿å…è§£æé”™è¯¯
        const tailwindScriptTag = '<script src="https://cdn.tailwindcss.com">' + '<' + '/script>';

        const fullPageHTML = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Traceè®¤çŸ¥å¤ç›˜ - ${sanitize(analysisResult.summary)}</title>
    <!-- ä½¿ç”¨æ‹¼æ¥åçš„ script æ ‡ç­¾ -->
    ${tailwindScriptTag}
    <style> 
        .no-print { display: none; } 
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC", sans-serif;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-purple-50 py-12 px-6">
    <!-- å¤åˆ¶ç»“æœé¡µé¢çš„å†…å®¹ -->
    <div class="max-w-5xl mx-auto">
        ${resultHTML}
    </div>
</body>
</html>`;

        const blob = new Blob([fullPageHTML], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Traceè®¤çŸ¥å¤ç›˜-${new Date().toISOString().split('T')[0]}.html`;
        a.click();
        URL.revokeObjectURL(url);
      }
      
      // å¯¼å‡º PDF (æ‰“å°)
      function exportAsPDF() {
        window.print();
      }

      // ç»‘å®šæ‰€æœ‰äº‹ä»¶
      // æ‹–æ”¾åŒºåŸŸ
      dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('border-purple-400', 'bg-purple-50');
      });
      dropZone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-purple-400', 'bg-purple-50');
      });
      dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-purple-400', 'bg-purple-50');
        if (e.dataTransfer.files.length > 0) {
          handleFile(e.dataTransfer.files[0]);
        }
      });
      // æ–‡ä»¶è¾“å…¥
      fileUpload.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFile(e.target.files[0]);
        }
      });
      // æŒ‰é’®
      removeFileBtn.addEventListener('click', resetUpload);
      analyzeButton.addEventListener('click', analyzeConversation);
      backButton.addEventListener('click', () => {
        resetUpload();
        showStage('upload');
      });
      exportHtmlBtn.addEventListener('click', exportAsHTML);
      exportPdfBtn.addEventListener('click', exportAsPDF);

      // åˆå§‹æ˜¾ç¤º
      showStage('upload');

    </script>
</body>
</html>
